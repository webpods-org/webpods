
> webpods-integration-tests@0.0.1 test
> mocha --exit



ðŸš€ Starting WebPods integration test setup...
âœ… WebPods integration test setup complete
  WebPods Authentication
    OAuth Endpoints
      âœ” should redirect to Google OAuth (162ms)
      âœ” should redirect to GitHub OAuth
      âœ” should reject invalid OAuth provider
      âœ” should handle OAuth callback
    JWT Authentication
      âœ” should reject requests without auth token to write operations
      âœ” should accept requests with valid auth token
      âœ” should reject expired JWT token
      âœ” should reject invalid JWT signature
      âœ” should reject malformed JWT token
    Public vs Authenticated Access
      âœ” should allow anonymous read on public streams
      âœ” should require auth for write on public streams
      âœ” should track author correctly
    Bearer Token Format
      âœ” should accept Bearer token in Authorization header
      âœ” should accept token without Bearer prefix
      âœ” should reject other auth schemes
    Cross-Pod Authentication
      âœ” should use same auth token across different pods
    User Metadata
      âœ” should store user metadata from OAuth
      âœ” should handle users from different OAuth providers

  WebPods Health Checks
    Main Domain Health
      âœ” should return healthy status
      âœ” should include service statuses
      âœ” should include uptime information
      âœ” should return proper content type
    Database Health
      âœ” should detect database connection
      âœ” should report database version
    Pod Subdomain Health
      1) should handle health checks on pod subdomains
      2) should verify wildcard subdomain routing works
    Readiness Check
      âœ” should have a readiness endpoint
    Liveness Check
      âœ” should have a liveness endpoint
    Metrics Endpoint
      âœ” should expose metrics if configured
    Error Handling
      âœ” should handle invalid health check paths
      âœ” should return JSON error for health check failures
    Performance
      âœ” should respond quickly to health checks
      âœ” should handle concurrent health checks
    Environment Information
      âœ” should include environment details
      âœ” should include node version

  WebPods Permissions
    Private Streams
      âœ” should only allow creator to read private stream
      âœ” should only allow creator to write to private stream
    Public Streams
      âœ” should allow anyone to read public stream
      âœ” should allow any authenticated user to write to public stream
    Permission Streams (Allow/Deny Lists)
      3) should support allow lists for reading
      4) should support deny lists for writing
      5) should support multiple permission streams
    Pod Ownership
      âœ” should transfer pod ownership via .meta/owner
      âœ” should only allow current owner to transfer ownership
    Stream Permission Updates
      âœ” should allow creator to update stream permissions
    Complex Permission Scenarios
      âœ” should handle nested stream paths with permissions
      âœ” should respect permissions on aliased content
      6) should handle permission stream updates correctly

  WebPods Rate Limiting
    Write Rate Limits
      âœ” should track write rate limits per user (43ms)
      7) should track pod creation rate limits separately
      8) should track stream creation rate limits
      9) should not count writes to existing streams as stream creation
    Read Rate Limits
      âœ” should track read rate limits separately from writes
      10) should track anonymous read rate limits by IP
    Rate Limit Windows
      âœ” should use hourly windows for rate limiting
      âœ” should reset count when window expires
      âœ” should clean up old rate limit windows
    Rate Limit Headers
      âœ” should return rate limit headers in responses
      âœ” should decrease remaining count with each request
    Rate Limit Enforcement
      âœ” should return 429 when rate limit is exceeded
      âœ” should allow requests from different users independently
    Different Rate Limits by Action
      11) should apply different limits for different actions

  WebPods Stream Operations
    Pod and Stream Creation
      12) should create pod and stream on first write
      âœ” should support nested stream paths
      âœ” should set custom permissions on stream creation
    Writing Records
      13) should write string content
      âœ” should write JSON content
      âœ” should respect X-Content-Type header
      âœ” should maintain hash chain
      âœ” should support aliases (including numeric)
      âœ” should reject duplicate aliases
    Reading Records
      âœ” should get record by positive index
      âœ” should get record by negative index
      âœ” should get range of records
      âœ” should get record by string alias
      âœ” should get record by numeric alias
      âœ” should list all records with pagination
      14) should return raw content with metadata in headers
    System Streams (.meta/)
      âœ” should create .meta/owner stream on pod creation
      âœ” should list streams via .meta/streams
      15) should update .meta/links for URL routing
      âœ” should only allow owner to write to .meta/ streams
    Permissions
      âœ” should enforce private read permissions
      âœ” should support permission streams (allow lists)
    Stream Deletion
      âœ” should delete stream and all records
      âœ” should prevent deletion of system streams
      âœ” should only allow creator to delete stream
    Content Types and Serving
      16) should serve HTML directly with correct content type
      17) should serve CSS with correct content type
      18) should serve JSON with correct content type

ðŸ›‘ Shutting down WebPods integration tests...
âœ… WebPods integration test teardown complete

  72 passing (44s)
  18 failing

  1) WebPods Health Checks
       Pod Subdomain Health
         should handle health checks on pod subdomains:
     AssertionError: expected 200 to be one of [ 404, 302 ]
      at Context.<anonymous> (src/tests/health.test.ts:84:37)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  2) WebPods Health Checks
       Pod Subdomain Health
         should verify wildcard subdomain routing works:
     ReferenceError: require is not defined
      at Context.<anonymous> (src/tests/health.test.ts:101:19)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  3) WebPods Permissions
       Permission Streams (Allow/Deny Lists)
         should support allow lists for reading:

      AssertionError: expected 403 to equal 200
      + expected - actual

      -403
      +200
      
      at Context.<anonymous> (src/tests/permissions.test.ts:155:35)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  4) WebPods Permissions
       Permission Streams (Allow/Deny Lists)
         should support deny lists for writing:

      AssertionError: expected 201 to equal 403
      + expected - actual

      -201
      +403
      
      at Context.<anonymous> (src/tests/permissions.test.ts:184:34)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  5) WebPods Permissions
       Permission Streams (Allow/Deny Lists)
         should support multiple permission streams:

      AssertionError: expected 403 to equal 200
      + expected - actual

      -403
      +200
      
      at Context.<anonymous> (src/tests/permissions.test.ts:223:34)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  6) WebPods Permissions
       Complex Permission Scenarios
         should handle permission stream updates correctly:

      AssertionError: expected 403 to equal 200
      + expected - actual

      -403
      +200
      
      at Context.<anonymous> (src/tests/permissions.test.ts:338:34)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  7) WebPods Rate Limiting
       Write Rate Limits
         should track pod creation rate limits separately:
     AssertionError: expected undefined to exist
      at Context.<anonymous> (src/tests/rate-limit.test.ts:72:26)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  8) WebPods Rate Limiting
       Write Rate Limits
         should track stream creation rate limits:
     AssertionError: expected undefined to exist
      at Context.<anonymous> (src/tests/rate-limit.test.ts:89:29)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  9) WebPods Rate Limiting
       Write Rate Limits
         should not count writes to existing streams as stream creation:
     TypeError: Cannot read properties of undefined (reading 'count')
      at Context.<anonymous> (src/tests/rate-limit.test.ts:108:26)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  10) WebPods Rate Limiting
       Read Rate Limits
         should track anonymous read rate limits by IP:
     AssertionError: expected undefined to exist
      at Context.<anonymous> (src/tests/rate-limit.test.ts:163:25)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  11) WebPods Rate Limiting
       Different Rate Limits by Action
         should apply different limits for different actions:

      AssertionError: expected 201 to equal 429
      + expected - actual

      -201
      +429
      
      at Context.<anonymous> (src/tests/rate-limit.test.ts:398:42)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  12) WebPods Stream Operations
       Pod and Stream Creation
         should create pod and stream on first write:
     AssertionError: expected { sequence_num: +0, â€¦(7) } to have property 'content' of 'Hello WebPods!', but got { content: 'Hello WebPods!' }
      at Context.<anonymous> (src/tests/streams.test.ts:48:37)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  13) WebPods Stream Operations
       Writing Records
         should write string content:

      AssertionError: expected 1 to equal +0
      + expected - actual

      -1
      +0
      
      at Context.<anonymous> (src/tests/streams.test.ts:115:45)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  14) WebPods Stream Operations
       Reading Records
         should return raw content with metadata in headers:

      AssertionError: expected 'text/plain; charset=utf-8' to equal 'text/plain'
      + expected - actual

      -text/plain; charset=utf-8
      +text/plain
      
      at Context.<anonymous> (src/tests/streams.test.ts:241:51)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  15) WebPods Stream Operations
       System Streams (.meta/)
         should update .meta/links for URL routing:

      AssertionError: expected 404 to equal 200
      + expected - actual

      -404
      +200
      
      at Context.<anonymous> (src/tests/streams.test.ts:305:38)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  16) WebPods Stream Operations
       Content Types and Serving
         should serve HTML directly with correct content type:

      AssertionError: expected 'text/html; charset=utf-8' to equal 'text/html'
      + expected - actual

      -text/html; charset=utf-8
      +text/html
      
      at Context.<anonymous> (src/tests/streams.test.ts:436:51)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  17) WebPods Stream Operations
       Content Types and Serving
         should serve CSS with correct content type:

      AssertionError: expected 'text/css; charset=utf-8' to equal 'text/css'
      + expected - actual

      -text/css; charset=utf-8
      +text/css
      
      at Context.<anonymous> (src/tests/streams.test.ts:447:51)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)

  18) WebPods Stream Operations
       Content Types and Serving
         should serve JSON with correct content type:

      AssertionError: expected 'application/json; charset=utf-8' to equal 'application/json'
      + expected - actual

      -application/json; charset=utf-8
      +application/json
      
      at Context.<anonymous> (src/tests/streams.test.ts:456:51)
      at process.processTicksAndRejections (node:internal/process/task_queues:105:5)



